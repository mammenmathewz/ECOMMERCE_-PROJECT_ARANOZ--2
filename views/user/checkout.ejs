<%- include('../partials/head') %>
  <!-- Header part end-->
  <%- include('../partials/navbar') %>


  

    <section class="checkout_area padding_top">
      <div class="container">
        <div style="margin-top: 3%" class="billing_details">
          <div class="row">
            <div class="col-lg-6">
              <!-- Button trigger modal -->
              <button data-toggle="modal"  class="btn_3" data-target="#addressModal">CLICK TO ADD NEW ADDRESS</button>

              <!-- Modal -->
              <div class="modal fade" id="addressModal" tabindex="-1" role="dialog" aria-labelledby="addressModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="addressModalLabel">Add New Address</h5>
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">Ã—</span>
                      </button>
                    </div>
                    <div class="modal-body">
                      <form class="row contact_form" action="/addAddress" method="post" >
                          <input type="hidden" name="redirect" value="/checkout">
                          <div class="col-md-6 form-group p_star">
                              <input type="text" class="form-control" id="first" name="first_name" placeholder="First name" required/>
                              
                          </div>
                          <div class="col-md-6 form-group p_star">
                              <input type="text" class="form-control" id="last" name="last_name" placeholder="Last name"required/>
                              
                          </div>
              
                          <div class="col-md-6 form-group p_star">
                              <input type="text" class="form-control" id="number" name="phone" placeholder="Phone number" required/>
                             
                          </div>
              
              
                          <div class="col-md-12 form-group p_star">
                              <input type="text" class="form-control" id="add1" name="address1" placeholder="Address line 01" required/>
                             
                          </div>
                          <div class="col-md-12 form-group p_star">
                              <input type="text" class="form-control" id="add2" name="address2" placeholder="Address line 02" required/>
                            
                          </div>
                          <div class="col-md-12 form-group p_star">
                              <input type="text" class="form-control" id="city" name="city" placeholder="Town/City" required/>
                             
                          </div>
                          <div class="col-md-12 form-group p_star">
                              <input type="text" class="form-control" id="district" name="district" placeholder="District" required/>
                              
                          </div>
                          <div class="col-md-12 form-group p_star">
                              <input type="text" class="form-control" id="state" name="state" placeholder="State" required/>
                             
                          </div>
              
                          <div class="col-md-12 form-group">
                              <input type="text" class="form-control" id="zip" name="pin"
                                  placeholder="Postcode/ZIP" required />
                          </div>
              
                         <button style="margin-left: auto; margin-right: auto;" class="tp_btn" type="submit">ADD NEW ADDRESS </button>
                      </form>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                   
                    </div>
                  </div>
                </div>
              
                
              </div>

              <div class="col-sm-12" style="margin-top: 4%">
                <% if (user.address) { %>
                  <% user.address.forEach(function(address) { %>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="addressRadio" id="<%= address._id %>"
                        value="<%= address._id %>" onclick="updateAddress(this.value)" />

                      <label class="form-check-label" for="<%= address._id %>">
                        <h4>
                          <%= address.first_name %>
                            <%=" "+ address.last_name %></h4>
                <span><%=` MOB: ${address.phone}` %></span>
                <p><%= address.address1 %></p>
                <p><%= address.address2 %></p>
                <p><%= address.district %>, <%= address.state %></p>
                <p><%= address.pin %></p>
              </label>
            </div>
            <hr />
            <% }) %> <% } %>
          </div>
        </div>

        <div class=" col-lg-6">
                              <div class="order_box">
                                <h2>Your Order</h2>
                                <ul class="list">
                                  <li>
                                    <a>Product
                                      <span>Total</span>
                                    </a>
                                  </li>
                                  <% cart.items.forEach(item=> { %>
                                    <li>
                                      <a style="display: flex; justify-content: space-between">
                                        <span class="first" style="flex-grow: 1; flex-basis: 50%">
                                          <%= item.productId.brand.name %>
                                        </span>
                                        <span class="middle" style="flex-grow: 0; flex-basis: auto; margin: 0 10px">x
                                          <%= item.quantity %>
                                        </span>
                                        <span class="last" style="flex-grow: 1; flex-basis: 50%; text-align: right">
                                          <%= item.quantity * item.productId.saleprice %>
                                        </span>
                                      </a>
                                    </li>

                                    <% }) %>
                                </ul>
                                <ul class="list list_2">
                                  <li>
                                    <a>Total
                                      <span>
                                        <%= cart.total %>
                                      </span>
                                    </a>
                                  </li>
                                </ul>

                                <form id="paymentForm" style="padding-top: 2%">
                                  <div class="row">
                                    <input type="hidden" id="hiddenAddress" name="selectedAddress" />
                                  </div>
                                  <div class="payment_item">
                                    <div class="radion_btn">
                                      <input type="radio" id="f-option5" name="selector" value="Cash on delivery" />
                                      <label for="f-option5">Cash on delivery</label>
                                    </div>
                                  </div>
                                  <div class="payment_item active">
                                    <div class="radion_btn">
                                      <input type="radio" id="f-option6" name="selector" value="Online payment" />
                                      <label for="f-option6">Online Payment</label>
                                    </div>
                                  </div>
                                  <button type="button" class="btn_3" id="rzp-button1">
                                    Pay with Razorpay
                                  </button>
                                </form>
                              </div>
                    </div>
              </div>
            </div>
          </div>
    </section>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>


<!-- Bootstrap JS -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

<!-- SweetAlert -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/11.10.4/sweetalert2.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Razorpay -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>




    <script>
      var cashOnDelivery = document.getElementById("f-option5");
      var paypal = document.getElementById("f-option6");
      var submitButton = document.getElementById("rzp-button1");

      cashOnDelivery.addEventListener("change", updateButton);
      paypal.addEventListener("change", updateButton);

      function updateButton() {
        if (cashOnDelivery.checked) {
          submitButton.textContent = "Confirm Order";
        } else if (paypal.checked) {
          submitButton.textContent = "Proceed to Razorpay";
        }
      }
      function updateAddress(addressId) {
        document.getElementById("hiddenAddress").value = addressId;
      }
    </script>

    <script>
      $("#rzp-button1").click(function (e) {
    e.preventDefault();

    var selectedAddress = $("#hiddenAddress").val();
    var paymentMethod = $("input[name='selector']:checked").val();

    if (!paymentMethod) {
        Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: 'Please select a payment method.'
        });
        return;  
    }

    if (!selectedAddress) {
        Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: 'Please select an address.'
        });
        return; 
    }


    updateAddress(selectedAddress);
    console.log("address:" + selectedAddress + "payment" + paymentMethod);

    if (paymentMethod === "Cash on delivery") {
        handleCashOnDelivery(selectedAddress);
    } else if (paymentMethod === "Online payment") {
        handleOnlinePayment(selectedAddress);
    }
});


      function handleCashOnDelivery(selectedAddress) {
        // Send a POST request to the server to confirm the order
        $.ajax({
          url: "/confirmOrder",
          method: "POST",
          contentType: "application/json",
          data: JSON.stringify({
            paymentMethod: "Cash on Delivery",
            selectedAddress: selectedAddress,
          }),
          success: function (response) {
            // Redirect the user to the confirmation page
            window.location.href = response.redirectUrl;
          },
        });
      }

      function handleOnlinePayment(selectedAddress) {
        var settings = {
          url: "/create/orderId",
          method: "POST",
          timeout: 0,
          headers: {
            "Content-Type": "application/json",
          },
          data: JSON.stringify({
            amount: "<%= cart.total %>",
            selectedAddress: selectedAddress,
            paymentMethod: "Online payment",
          }),
        };

        // Creates a new orderId every time
        $.ajax(settings).done(function (createOrderResponse) {
          console.log(createOrderResponse); // Add this line
          var orderId = createOrderResponse.orderId;
          console.log(orderId);

          var options = {
            key: "rzp_test_O7L5XOIOghh2QG", // Enter the Key ID generated from the Dashboard
            amount: " <%= cart.total.toString() %>", // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
            currency: "INR",
            name: "Aranoz",
            description: "Test Transaction",
            image: "/user/img/logo.png",
            order_id: orderId, // Use the orderId from the previous request
            handler: function (response) {
              var data = {
                razorpay_order_id: response.razorpay_order_id,
                razorpay_payment_id: response.razorpay_payment_id,
                razorpay_signature: response.razorpay_signature,
              };

              // Send a POST request to the server to verify the payment and save the order details

              $.ajax({
                url: "/paymentverify",
                method: "POST",
                data: JSON.stringify(data),
                contentType: "application/json",
                success: function (verifyPaymentResponse) {
                  console.log(verifyPaymentResponse); // Log the response
                  window.location.href = verifyPaymentResponse.redirectUrl; // Redirect the user
                },

                error: function (err) {
                  // Handle any errors
                  console.log("Payment verification and order saving failed", err);
                },
              });
            },

            prefill: {
              name: '<%= user.first_name %><%=" "+ user.last_name  %>',
              email: "<%= user.email %>",
              contact: "<%= user.phone %>",
            },

            notes: {
              address: "Razorpay Corporate Office",
            },
            theme: {
              color: "#FF3368",
            },
          };

          var rzp1 = new Razorpay(options);
          rzp1.on("payment.failed", function (response) {
            alert(response.error.code);
            alert(response.error.description);
            alert(response.error.source);
            alert(response.error.step);
            alert(response.error.reason);
            alert(response.error.metadata.order_id);
            alert(response.error.metadata.payment_id);
          });
          // document.getElementById("rzp-button1").onclick = function (e) {
          rzp1.open();
          //   e.preventDefault();
          // };
        });
      }
    </script>